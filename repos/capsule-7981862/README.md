Replication Package: Integrating Data Across Misaligned Spatial Units
---------------------------------------------------------------------

Updated 12/16/2022.

# Table of Contents
1. [Overview](#overview)
2. [Data Sources](#data)
3. [System Requirements](#system)
4. [Instructions](#instructions)


# Overview <a name="overview"></a>

The code in this replication package reconstructs the analysis for Zhukov, Byers, Davidson and Kollman, "Integrating Data Across Misaligned Spatial Units," forthcoming in *Political Analysis*. Two R scripts run all of the code to generate the 6 figures and 1 table in the main body of the paper (`run2_main.R`), and all empirical results in the Online Appendix (`run3_appendix.R`). 

## Contents of Replication Package

- `README.md`: this file
- `master.R`: R script that executes all replication code in sequence
- `code/`: directory with R scripts sourced by `master.R`
    - `run1_setup.R`: R script to install missing packages and dependencies
    - `run2_main.R`: R script to replicate all figures and tables in main text
    - `run3_appendix.R`: R script to replicate all empirical figures and tables in appendix
    - `functions.R`: R script with custom functions sourced by `run2_main.R` and `run3_appendix.R`
- `data/`: directory with data files used by `run2_main.R` and `run3_appendix.R`
    - `USA/`: data files on elections and spatial units in U.S.
        - `CLEA_USA_GA_2014_PCT.RDS`: precinct-level results for 2014 Congressional elections in Georgia
        - `CLEA_USA_GA_2014_CST.RDS`: constituency-level results for 2014 Congressional elections in Georgia
        - `VTD_USA_GA_2012_PCT_wgs.geojson`: precinct boundary geometries
        - `GRED_USA_GA_2014_CST_wgs.geojson`: constituency boundary geometries
        - `HEXGRID_USA_GA_2014_HEX05_wgs.geojson`: grid cell boundary geometries
        - `GPW_USA_GA_2015_POP.asc`: population density raster
    - `SWE/`: data files on elections and spatial units in Sweden
        - `CLEA_SWE_2010_PCT.RDS`: precinct-level results for 2010 Swedish parliamentary elections
        - `CLEA_SWE_2010_CST.RDS`: constituency-level results for 2010 Swedish parliamentary elections
        - `VAL_SWE_2010_PCT_wgs.geojson`: precinct boundary geometries
        - `GRED_SWE_2010_CST_wgs.geojson`: constituency boundary geometries
        - `HEXGRID_SWE_2020_HEX05_wgs.geojson`: grid cell boundary geometries
        - `GPW_SWE_2015_POP.asc`: population density raster
    - `IND/`: data files on violence and elections in India
        - `CLEA_Lower_IND_PRIOGRID2018_PRIO_YEAR.RDS`: grid cell-level election results
        - `xSub_MELTT1km1dB_Events_IND.csv`: political violence event data
        - `GADM_IND_2018_ADM0_wgs.geojson`: country boundary geometries
        - `PRIOGRID_IND_2018_PRIO_wgs.geojson`: grid cell boundary geometries
    - `r_output/`: directory with simulation results and other pre-processed files
- `results/`: directory with files generated by `run2_main.R` and `run3_appendix.R`
    - `fig*.png`: figures in PNG format 
    - `tab*.tex`: tables in LaTeX format 
    - `figA*.png`: appendix figures in PNG format 
    - `tabA*.tex`: appendix tables in LaTeX format

# Data Sources <a name="data"></a>

## 1. Spatial units

Data on constituency boundaries are from the GeoReferenced Electoral Districts Datasets project. The files provided with the replication package have simplified geometries (to reduce processing time) and are subsetted to include only the regions examined in the paper (e.g. state of Georgia). The original files can be downloaded from http://www.electiondataarchive.org/datacenter-gred.php. We used version 20190215. These data are in the public domain.

Citation info:
- Kollman, Ken, Allen Hicken, Daniele Caramani, David Backer, David Lublin, Joel Selway, David Lublin and Fabricio Vasselai. *GeoReferenced Electoral Districts Datasets*. Ann Arbor, MI: Center for Political Studies, University of Michigan, 2019.

Data objects provided as part of this archive:
- `Data/USA/GRED_USA_GA_2014_CST_wgs.geojson`
- `Data/SWE/GRED_SWE_2010_CST_wgs.geojson`

Data on electoral precinct boundaries for the U.S. state of Georgia are from the public Github repository of Aaron Strauss. The original files can be downloaded from https://github.com/aaron-strauss/precinct-shapefiles. These data are in the public domain.

Citation info:
- Strauss, Aaron. 2017. https://github.com/aaron-strauss/precinct-shapefiles.

Data objects provided as part of this archive:
- `Data/USA/VTD_USA_GA_2012_PCT_wgs.geojson`

Data on electoral precinct boundaries for Sweden are from the Swedish Electoral Authority. The original files can be downloaded from data.val.se/val/val2010/statistik. These data are in the public domain.

Citation info:
- The Swedish Electoral Authority. 2019. data.val.se/val/val2010/statistik.

Data objects provided as part of this archive:
- `Data/SWE/VAL_SWE_2010_PCT_wgs.geojson`

Data on hexagonal grid cell boundaries for Sweden were created by the authors. These data are in the public domain.

Citation info:
- Zhukov, Byers, Davidson, and Kollman (2022)

Data objects provided as part of this archive:
- `Data/USA/HEXGRID_USA_GA_2014_HEX05_wgs.geojson`
- `Data/SWE/HEXGRID_SWE_2020_HEX05_wgs.geojson`

Data on country boundaries for India are from the Database of Global Administrative Areas. The files provided with the replication package have simplified geometries (to reduce processing time). The original data can be downloaded from https://gadm.org. We used version 3.6. For licensing terms, see https://gadm.org/license.html.

Citation info:
- GADM. *Database of Global Administrative Areas*, Version 3.6 (2018).

Data objects provided as part of this archive:
- `Data/IND/GADM_IND_2018_ADM0_wgs.geojson`

Data on rectangular grid cell boundaries for India are from PRIO-GRID 2.0. The files provided with the replication package have been subsetted to include only those overlapping with India in its 2022 boundaries. The original data can be downloaded from https://grid.prio.org. We used version 2.0. For licensing terms, see https://grid.prio.org/#/codebook.

Citation info:
- Tollefsen, Andreas Forø, Håvard Strand and Halvard Buhaug. "PRIO-GRID: A unified spatial data structure." *Journal of Peace Research* 49, no. 2 (2012): 363-374. doi: 10.1177/0022343311431287

Data objects provided as part of this archive:
- `Data/IND/PRIOGRID_IND_2018_PRIO_wgs.geojson`


## 2. Elections

Data on constituency-level election results in the U.S., Sweden and India are from the Constituency-Level Elections Archive project. The files provided with the replication package have been pre-processed to collapse each constituency's results in each election cycle to a single row, and to calculate electoral competitiveness scores as described in the main text. The original files can be downloaded from http://www.electiondataarchive.org/index.html. We used version Release 14 (20201216). These data are in the public domain.

Citation info:
- Kollman, Ken, Allen Hicken, Daniele Caramani, David Backer, and David Lublin. *Constituency-Level Elections Archive*. Ann Arbor, MI: Center for Political Studies, University of Michigan [producer and distributor], 2019. Web. 17 June 2019. 

Data objects provided as part of this archive:
- `Data/USA/CLEA_USA_GA_2014_CST.RDS`
- `Data/SWE/CLEA_SWE_2010_CST.RDS`
- `Data/IND/CLEA_Lower_IND_PRIOGRID2018_PRIO_YEAR.RDS`

Data on precinct-level electoral results for the U.S. state of Georgia are from the Harvard Election Data Archive. The original files can be downloaded from https://projects.iq.harvard.edu/eda. These data are in the public domain.

Citation info:
- Ansolabehere, Stephen; Ban, Pamela; Morse, Michael, 2018, "Precinct-Level Election Data, 2014", https://doi.org/10.7910/DVN/B51MPX, Harvard Dataverse, V1, UNF:6:PR/uz4ma+Hs0TALYyMzr0w== [fileUNF].

Data objects provided as part of this archive:
- `Data/USA/CLEA_USA_GA_2014_PCT.RDS`

Data on precinct-level electoral results for Sweden are from the Swedish Electoral Authority. The original files can be downloaded from data.val.se/val/val2010/statistik. These data are in the public domain.

Citation info:
- The Swedish Electoral Authority. 2019. The precincts boundaries are from data.val.se/val/val2010/statistik.

Data objects provided as part of this archive:
- `Data/SWE/CLEA_SWE_2010_PCT.RDS`


## 3. Population Density

Data on population density in the U.S. and Sweden are from the Gridded Population of the World project. The files provided with the replication package have been subsetted by geography. The original files can be downloaded from https://sedac.ciesin.columbia.edu/data/collection/gpw-v4. We used version 4 (2015). These data are in the public domain.

Citation info:
- Center for International Earth Science Information Network - CIESIN - Columbia University. 2016. Gridded Population of the World, Version 4 (GPWv4): Population Density. Palisades, NY: NASA Socioeconomic Data and Applications Center (SEDAC). http://dx.doi.org/10.7927/H4NP22DQ. 

Data objects provided as part of this archive:
- `Data/USA/GPW_USA_GA_2015_POP.asc`
- `Data/SWE/GPW_SWE_2015_POP.asc`


## 4. Violence

Data on political violence in India are from the Cross-National Data on Sub-National Violence (xSub) project. xSub integrates information on political violence from 23 open-source event data sources. The original files can be downloaded from http://cross-sub.org/. We used the 2021 version. These data are in the public domain.

Citation info:
- Zhukov, Yuri M., Christian Davenport, and Nadiya Kostyuk. "Introducing xSub: a new portal for cross-national data on sub-national violence." *Journal of Peace Research* 56, no. 4 (2019): 604-614.

Data objects provided as part of this archive:
- `Data/IND/xSub_MELTT1km1dB_Events_IND.csv`


# System Requirements <a name="system"></a>

## 1. Software Requirements

This code will not replicate on a Windows machine.

Portions of the code rely on forking to run in parallel on multicore systems, which requires Linux or Mac OS. Single-core processing is possible on Windows if `mc.cores = 1` in `parallel::mclapply`.

System-level dependencies (Linux)
- `libfftw3-dev` (3.3.7-1)
- `libgdal-dev` (2.2.3+dfsg-2)
- `libgeos-dev` (3.6.2-1build2)
- `libjq-dev` (1.5+dfsg-2)
- `libpq-dev` (10.22-0ubuntu0.18.04.1)
- `libprotobuf-dev` (3.0.0-9.1ubuntu1)
- `libssl-dev` (1.1.1-1ubuntu2.1~18.04.2)
- `protobuf-compiler` (3.0.0-9.1ubuntu1)
- `unixodbc-dev` (2.3.4-1.1ubuntu3)

R version 3.6.3 (2020-02-29)
- Platform: `x86_64-pc-linux-gnu` (64-bit)
- Running under: Ubuntu 18.04.6 LTS
- The script `run1_setup.R` will install all missing packages and dependencies, and should be run prior to executing `run2_main.R` or `run3_appendix.R`.
- Attached packages:
    - `data.table` (1.14.2)
    - `dplyr` (1.0.8)
    - `Formula` (1.2-3)
    - `gstat` (2.0-9)
    - `mgcv` (1.8-33)
    - `nlme` (3.1-149)
    - `parallel` (3.6.3)
    - `randomForest` (4.6-14)
    - `raster` (3.5-29)
    - `rpart` (4.1-15)
    - `sf` (1.0-5)       
    - `sp` (1.5-0)
    - `spatstat` (2.3-4)
    - `spatstat.core` (2.4-4)
    - `spatstat.data` (3.0-0)
    - `spatstat.geom` (3.0-3)
    - `spatstat.linnet` (2.3-2)
    - `spatstat.random` (2.2-0)
    - `spData` (0.3.8)
    - `spdep` (1.1-5)
    - `stringr` (1.4.0)
    - `SUNGEO` (0.2.292)
- Other packages loaded via a namespace (and not attached):
    - `abind` (1.4-5)
    - `automap` (1.0-14)
    - `assertthat` (0.2.1)
    - `bitops` (1.0-6)
    - `boot` (1.3-25)
    - `cartogram` (0.2.0)
    - `class` (7.3-17)
    - `classInt` (0.4-3)
    - `cli` (3.2.0)
    - `coda` (0.19-3)
    - `codetools` (0.2-16)
    - `compiler` (3.6.3)
    - `crayon` (1.3.4)
    - `crul` (0.9.0)
    - `curl` (4.3)
    - `DBI` (1.1.0)
    - `deldir` (0.1-25)
    - `e1071` (1.7-3)
    - `ellipsis` (0.3.2)
    - `expm` (0.999-5)
    - `fansi` (0.4.1)
    - `fasterize` (1.0.3)
    - `FNN` (1.1.3)
    - `Formula` (1.2-3)
    - `gdata` (2.18.0)
    - `generics` (0.1.2)
    - `geojsonlint` (0.4.0)
    - `glue` (1.6.2)
    - `gmodels` (2.18.1)
    - `goftest` (1.2-2)
    - `grid` (3.6.3)
    - `gtools` (3.8.2)
    - `httpcode` (0.3.0)
    - `httr` (1.4.2)
    - `intervals` (0.15.2)
    - `lattice` (0.20-41)
    - `jsonlite` (1.7.2)
    - `jsonvalidate` (1.1.0)
    - `KernSmooth` (2.23-17)
    - `LearnBayes` (2.15.1)
    - `lifecycle` (1.0.1)
    - `magrittr` (2.0.2)
    - `MASS` (7.3-53)
    - `Matrix` (1.2-18)
    - `measurements` (1.4.0)
    - `packcircles` (0.3.3)
    - `pillar` (1.7.0)
    - `pkgconfig` (2.0.3)
    - `plyr` (1.8.6)
    - `polyclip` (1.10-0)
    - `purrr` (0.3.4)
    - `R6` (2.4.1)
    - `RANN` (2.6.1)
    - `Rcpp` (1.0.8.3)
    - `RCurl` (1.98-1.2)
    - `reshape` (0.8.8)
    - `rlang` (1.0.2)
    - `rmapshaper` (0.4.4)
    - `spacetime` (1.2-3)
    - `spatstat.sparse` (2.0-0)
    - `spatstat.utils` (2.2-0)
    - `splines` (3.6.3)
    - `stringi` (1.4.6)
    - `tensor` (1.5)
    - `terra` (1.6-17)
    - `tibble` (3.1.6)
    - `tidyselect` (1.1.1)
    - `tidyr` (1.2.0)
    - `tools` (3.6.3)
    - `units` (0.6-6)
    - `xts` (0.12-0)
    - `utf8` (1.1.4)
    - `V8` (3.4.0)
    - `vctrs` (0.3.8)
    - `zoo` (1.8-8)    


## 2. Hardware Requirements

Approximate time needed to reproduce the analyses on a standard (2022) desktop machine is 10 minutes (minimum reproducible run) to 1-2 weeks (full interactive run).

The code was last run on a 16-core (Intel(R) Core(TM) i9-9880H CPU @ 2.30GHz) laptop with 64 GB of RAM, running Ubuntu 18.04.6 LTS. Computation took about 2 weeks. 

The code was also tested on a 96-core (Intel(R) Xeon(R) Gold 5220R CPU @ 2.20GHz) server with 376 GB of RAM, running Ubuntu 20.04.4 LTS. Computation took about 1 week. 


# Instructions to Replicators <a name="instructions"></a>

1. Download the compressed file `Replication_ZBDK.tar.gz` from DataVerse. Extract the contents of the tarball to a directory of your choice. The extracted scripts and data files should be stored in the same prepared subdirectories as in the tarball. Do not move the files after unzipping. 
2. If needed, edit the preamble to `master.R` to adjust the default working directory in `setwd()` to the unzipped folder's location on your system. The path should point to the directory that contains this file, `master.R`.
3. OPTION A (non-interactive): To execute everything in one go, open a new session in R and run `master.R`. This script with source all the code in the `Code/` directory. We recommend setting the `intermz` parameter in `master.R` to `TRUE` for non-interactive runs. This will reduce computation time significantly by importing pre-processed output.
4. OPTION B (interactive): To execute the code line by line, run the scripts in the following order (after setting the working directory in R):
    a. Run `Code/run1_setup.R` to set up the working environment. 
    b. Run `Code/run2_main.R` to replicate all figures and tables in the main text.
    c. Run `Code/run3_appendix.R` to replicate all figures and tables in the Online Appendix.

**NOTE**

The following code chunks take a very long time (days) to run:
- `Code/run2_main.R`: Change of support for Figures 2 and 3 (lines 122-505) 
- `Code/run2_main.R`: Monte Carlo simulations (lines 848-1317)
- `Code/run3_appendix.R`: Change of support for Figures A5.4 and A5.5 (lines 371-750)

To save time, we recommend setting the `intermz` parameter in `master.R` to `TRUE`. The script will then skip these chunks and use the pre-processed output in the `data/r_output/` directory to recreate the graphics and tables.